import pandas as pd
import numpy as np
import math
import gep_lib.feature_lib as flb
import gep_lib.const as cst
import gep_lib.parse_cmd as pcmd
import gep_lib.utils as ut
import datetime
import multiprocessing as mp

pd.set_option("display.max_rows", None)
pd.set_option("display.max_columns", None)
import glob

import argparse


def init_arguments_feature():
    def str_to_bool(s):
        if s == 'true':
            return True
        elif s == 'false':
            return False
        else:
            raise ValueError

    def is_none(s):
        if s == "none":
            return None
        else:
            return int(s)

    parser = argparse.ArgumentParser()

    parser.add_argument('-n', '--nrows', type=is_none, dest="nrows", default=None,
                        help="map key(rider or rider_poi)")
    parser.add_argument('-k', '--key', type=str, dest="key", default=None,
                        help="key file")
    parser.add_argument('-fk', '--feakey', type=str, dest="fkey", default=None,
                        help="sub_key")

    # parser.add_argument('-f', '--allfea', type=str, dest="all_fea", default=None,
    #                     help="map key(rider or rider_poi)")
    parser.add_argument('-t', '--top', type=int, dest="topn", default=10,
                        help="map key(rider or rider_poi)")

    return parser.parse_args()


args = init_arguments_feature()

nrows = args.nrows
test_nrows = nrows

with ut.tick_tock('read_data'):
    train_key = pd.read_csv(cst.train_prefix + "{}.csv".format(args.key), ',', nrows=nrows)
    test_key = pd.read_csv(cst.test_prefix + "{}.csv".format(args.key), ',', nrows=nrows)
    train_index = len(train_key)
    ori_columns = train_key.columns
    out = pd.concat([train_key, test_key])
    allfea="V258,C1_fq_enc,TransactionAmt,C13,C14,V201,TransactionDT,C1,DT_D_total,C11,C12,D15,V257,C14_uid3_skew,D2,V70,V307,DT_D,addr1_fq_enc,V187,addr1,uid_DT_D,cross_uid3_kernel_median_C14,cross_uid3_kernel_median_TransactionAmt,TransactionAmt_uid3_skew,uid3_TransactionAmt_mean,DT_day,cross_uid3_kernel_median_V201,V282,card1,uid_DT_W,uid2,DT_hour,TransactionAmt_uid3_max,C6_fq_enc,DT_W_total,C13_fq_enc,TransactionAmt_uid3_std,TransactionAmt_uid3_min,D10,C14_fq_enc,C14_uid3_std,V310,cross_uid3_kernel_median_V258,D1,C14_uid3_sum,TransactionAmt_uid3_sum,D4,V279,uid3,id_02,C14_card1_skew,V45,V201_uid3_std,C14_uid3_max,C14_card2_skew,cross_card1_kernel_median_V258,C10_fq_enc,V201_uid3_skew,id_20,C9_fq_enc,card2,D3,cross_card2_kernel_median_V201,C5,V201_card1_std,V258_uid3_skew,V258_uid3_std,uid3_fq_enc,D8,dist1,TransactionAmt_card2_skew,C14_card1_std,uid3_TransactionAmt_std,cross_card1_kernel_median_C14,cross_card2_kernel_median_C14,D4_fq_enc,D1_fq_enc,D2_fq_enc,cate_stat_D15_P_emaildomain_sum,TransactionAmt_card1_skew,C14_card1_max,cross_uid_kernel_median_V201,cross_card2_kernel_median_V258,V201_card2_std,V62,V258_card1_std,V201_card2_skew,C6,DT_day_week,uid_TransactionAmt_std,dist1_fq_enc,cross_uid2_kernel_median_V201,V258_uid_skew,cross_card1_kernel_median_V201,uid2_TransactionAmt_mean,cate_stat_cross_DeviceInfo_kernel_median_TransactionAmt,D11,cate_stat_cross_R_emaildomain_kernel_median_C14,TransactionAmt_card2_max,C14_card2_max,V201_uid_skew,V258_uid3_sum,C14_card2_std,TransactionAmt_uid_min,cross_uid_kernel_median_TransactionAmt,cross_uid2_kernel_median_V258,cate_stat_cross_P_emaildomain_kernel_median_V13,id_19,V130,V258_card2_std,cate_stat_cross_P_emaildomain_kernel_median_C14,TransactionAmt_card2_std,C14_uid2_skew,C14_uid_skew,V316,V201_uid2_std,cate_stat_D15_P_emaildomain_std,TransactionAmt_card2_min,TransactionAmt_uid_max,C14_uid2_std,cross_card1_kernel_median_TransactionAmt,card2_TransactionAmt_mean,cate_stat_cross_P_emaildomain_kernel_median_TransactionAmt,cate_stat_cross_id_31_kernel_median_D15,V87,cross_uid_kernel_median_C14,cross_uid2_kernel_median_C14,P_emaildomain,DT_M_total,cate_stat_V13_P_emaildomain_std,cate_stat_C14_DeviceInfo_std,V83,V258_card1_skew,cate_stat_C14_M4_sum,V201_uid3_sum,cate_stat_TransactionAmt_P_emaildomain_std,V258_uid3_count,TransactionAmt_uid_sum,cate_stat_D15_M5_sum,V258_card2_skew,TransactionAmt_uid_skew,V256,card2_fq_enc,uid_TransactionAmt_mean,cross_card2_kernel_median_TransactionAmt,TransactionAmt_uid2_skew,uid2_TransactionAmt_std,V74,M6,C14_card1_sum,cate_stat_cross_id_31_kernel_median_TransactionAmt,id_31,cate_stat_cross_id_33_kernel_median_TransactionAmt,cate_stat_C14_P_emaildomain_std,id_05,V258_uid2_skew,D8_fq_enc,TransactionAmt_card1_max,V48,V201_card2_sum,TransactionAmt_uid2_min,V207,card1_TransactionAmt_mean,C14_uid3_count,V201_card1_skew,R_emaildomain,id_01,cate_stat_D15_id_31_sum,C14_uid2_max,V29,cross_uid2_kernel_median_TransactionAmt,V258_card1_max,V201_uid_std,card1_TransactionAmt_std,TransactionAmt_card1_min,cate_stat_C14_id_31_std,cate_stat_cross_DeviceInfo_kernel_median_C14,TransactionAmt_uid_std,C14_uid_std,id_06,cate_stat_cross_R_emaildomain_kernel_median_D15,cate_stat_cross_M4_kernel_median_D15,V258_card1_count,DeviceInfo_device,id_09,V165,cate_stat_C14_P_emaildomain_sum,TransactionAmt_uid2_max,V258_uid_std,C14_card2_sum,V201_uid2_skew,cate_stat_D15_R_emaildomain_std,cate_stat_cross_R_emaildomain_kernel_median_TransactionAmt,cate_stat_cross_P_emaildomain_kernel_median_D15,cate_stat_cross_id_31_kernel_median_C14,C14_uid_count,V49,cate_stat_TransactionAmt_id_31_sum,D14,cate_stat_V13_card6_std,D13,cate_stat_D15_id_31_std,V285,V78,TransactionAmt_uid2_sum,DeviceInfo,V54,M4,V53,V258_card2_max,V76,M5,cate_stat_D15_ProductCD_std,cate_stat_C14_R_emaildomain_sum,TransactionAmt_card2_sum,C14_uid_sum,V258_uid2_std,TransactionAmt_card1_std,id_13,V201_uid3_max,V332,V69,DeviceInfo_device_fq_enc,dist2,V311,TransactionAmt_card1_count,V201_card1_sum,uid,C14_uid2_sum,dist2_fq_enc,cate_stat_cross_DeviceInfo_kernel_median_D15,V258_uid_sum,cate_stat_D15_DeviceInfo_std,cate_stat_D15_id_33_std,V323,cate_stat_TransactionAmt_DeviceInfo_std,V12,V82,card5,cate_stat_TransactionAmt_id_31_std,cate_stat_TransactionAmt_R_emaildomain_std,cate_stat_TransactionAmt_id_33_std,V258_card5_skew,cate_stat_C14_id_31_sum,V324,id_31_device_fq_enc,V258_uid2_count,V61,V258_card1_sum,C5_fq_enc,V86,cross_card5_kernel_median_TransactionAmt,D6,TransactionAmt_card5_min,card2_TransactionAmt_std,V75,C14_uid2_count,V201_card2_count,cate_stat_cross_id_30_kernel_median_TransactionAmt,DT_W,cate_stat_TransactionAmt_M6_sum,V13,V201_card5_skew,V201_uid2_max,id_18,V19,V38,V258_uid2_max,cate_stat_cross_ProductCD_kernel_median_C14,V201_card1_count,V271,V203,TransactionAmt_card5_skew,V201_uid2_sum,C14_card5_max,V201_card5_std,D9,V266,cross_card5_kernel_median_C14,D6_fq_enc,cate_stat_cross_id_33_kernel_median_C14,V278,C14_uid_max,V56,id_14,M3,DeviceInfo_fq_enc,V201_card2_max,V291,V265,V293,D12,C14_card5_std,V258_card2_count,V233,V36,V267,V258_card5_max,id_30,cate_stat_V13_M2_sum,card5_TransactionAmt_std,cate_stat_cross_M6_kernel_median_V13,cate_stat_V13_P_emaildomain_sum,cate_stat_C14_R_emaildomain_std,V66,cate_stat_C14_DeviceInfo_sum,V201_uid2_count,ProductCD,cate_stat_V13_M5_sum,V55,cate_stat_cross_ProductCD_kernel_median_TransactionAmt,cate_stat_D15_DeviceInfo_sum,V24,cate_stat_TransactionAmt_M4_sum,V258_card3_max,cross_card5_kernel_median_V258,V99,cate_stat_TransactionAmt_id_30_std,cate_stat_TransactionAmt_DeviceInfo_sum,M_na,cate_stat_cross_id_30_kernel_median_D15,cate_stat_cross_id_30_kernel_median_C14,cate_stat_C14_id_30_std,cate_stat_V13_M3_sum,cate_stat_V13_M4_sum,cate_stat_D15_id_30_std,id_33,V169,V52,R_emaildomain_fq_enc,card5_TransactionAmt_mean,V35,C14_card3_skew,id_17,TransactionAmt_uid3_count,cate_stat_cross_id_33_kernel_median_D15,V30,cate_stat_cross_M9_kernel_median_C14,V258_uid_count,V319,id_30_fq_enc,cate_stat_D15_M4_std,V171,cate_stat_D15_id_30_sum,V223,cate_stat_C14_id_33_std,V25,V292,V217,V43,P_emaildomain_fq_enc,cate_stat_TransactionAmt_id_33_sum,V37,cate_stat_TransactionAmt_id_30_sum,TransactionAmt_uid_count,cross_card5_kernel_median_V201,cate_stat_TransactionAmt_id_16_sum,V201_uid3_min,V77,M9,V220,V300,V135,cate_stat_TransactionAmt_card4_sum,id_30_device,card3_fq_enc,cate_stat_V13_M8_sum,V170,V140,cate_stat_D15_id_33_sum,cate_stat_TransactionAmt_ProductCD_sum,cate_stat_TransactionAmt_P_emaildomain_sum,V218,cate_stat_D15_card4_std,cate_stat_TransactionAmt_R_emaildomain_sum,cate_stat_C14_id_30_sum,V221,V166,V33,cate_stat_C14_id_33_sum,C14_card3_max,cross_card3_kernel_median_V258,TransactionAmt_uid2_count,cate_stat_V13_M6_std,cate_stat_D15_M8_std,cate_stat_C14_M5_std,V219,C3_fq_enc,cate_stat_D15_M7_sum,cate_stat_TransactionAmt_M3_std,M7,cate_stat_C14_M4_std,V168,cate_stat_cross_M7_kernel_median_D15,V290,cate_stat_cross_M5_kernel_median_C14,cate_stat_C14_M6_std,cate_stat_C14_card6_std,V206,cate_stat_cross_DeviceType_kernel_median_D15,cate_stat_cross_M5_kernel_median_TransactionAmt,cate_stat_cross_M5_kernel_median_V13,cate_stat_D15_M3_std,M2,id_33_fq_enc,cate_stat_D15_M8_sum,V339,cate_stat_V13_M8_std,cate_stat_D15_ProductCD_sum,V139,cate_stat_TransactionAmt_M9_sum,cate_stat_D15_id_37_sum,cate_stat_C14_DeviceType_std,V176,cate_stat_cross_card6_kernel_median_D15,V167,cate_stat_cross_card4_kernel_median_TransactionAmt,cate_stat_D15_id_38_std,id_07,cate_stat_cross_M9_kernel_median_V13,cate_stat_TransactionAmt_card4_std,cate_stat_C14_card4_std,cate_stat_C14_M6_sum,cate_stat_cross_id_38_kernel_median_TransactionAmt,cate_stat_TransactionAmt_M2_sum,cate_stat_C14_id_23_sum,V42,cate_stat_cross_M3_kernel_median_V13,cate_stat_cross_card6_kernel_median_TransactionAmt,cate_stat_cross_ProductCD_kernel_median_D15,cate_stat_C14_id_16_std,C3,cate_stat_cross_card4_kernel_median_D15,cate_stat_TransactionAmt_M3_sum,cate_stat_V13_M5_std,cate_stat_C14_ProductCD_std,cate_stat_cross_M4_kernel_median_V13,cate_stat_D15_R_emaildomain_sum,cate_stat_cross_id_16_kernel_median_D15,cate_stat_cross_M2_kernel_median_TransactionAmt,cate_stat_C14_id_28_sum,cate_stat_D15_M6_sum,cate_stat_TransactionAmt_card6_std,id_10,cate_stat_cross_id_16_kernel_median_TransactionAmt,cate_stat_TransactionAmt_M5_sum,cate_stat_TransactionAmt_id_12_std,id_38,card6,cate_stat_TransactionAmt_M4_std,cate_stat_cross_M4_kernel_median_TransactionAmt,cate_stat_TransactionAmt_id_37_sum,DeviceType,cate_stat_cross_id_37_kernel_median_TransactionAmt,cate_stat_C14_id_12_sum,cate_stat_cross_M5_kernel_median_D15,cate_stat_cross_id_23_kernel_median_C14,cate_stat_V13_M7_sum,cate_stat_V13_id_35_sum,cate_stat_C14_M8_std,cate_stat_V13_M9_sum,id_23,cate_stat_TransactionAmt_M8_std,cate_stat_cross_id_36_kernel_median_TransactionAmt,cate_stat_cross_DeviceType_kernel_median_TransactionAmt,cate_stat_V13_id_38_std,V226,cate_stat_C14_id_29_sum,card4,cate_stat_V13_card6_sum,cate_stat_V13_card4_std,cate_stat_TransactionAmt_M6_std,cate_stat_V13_M6_sum,cate_stat_TransactionAmt_id_23_sum,cate_stat_cross_id_38_kernel_median_C14,cate_stat_cross_M2_kernel_median_C14,cate_stat_D15_id_12_sum,cate_stat_cross_M9_kernel_median_TransactionAmt,cate_stat_C14_id_38_std,cate_stat_TransactionAmt_M2_std,cate_stat_TransactionAmt_ProductCD_std,cate_stat_cross_card4_kernel_median_C14,cate_stat_D15_id_35_std,cate_stat_cross_M6_kernel_median_TransactionAmt,cate_stat_C14_id_37_std,cate_stat_TransactionAmt_id_36_sum,cate_stat_cross_M8_kernel_median_D15,cate_stat_cross_M1_kernel_median_TransactionAmt,cate_stat_cross_id_27_kernel_median_V13,cate_stat_V13_M7_std,cate_stat_C14_M7_sum,cate_stat_D15_id_28_std,cate_stat_TransactionAmt_M7_std,cate_stat_V13_card4_sum,cate_stat_cross_id_37_kernel_median_C14,cate_stat_C14_M9_sum,cate_stat_C14_id_35_std,cate_stat_C14_ProductCD_sum,cate_stat_V13_DeviceInfo_std,cate_stat_D15_id_12_std,cate_stat_C14_M8_sum,cate_stat_cross_M3_kernel_median_C14,cate_stat_cross_M9_kernel_median_D15,cate_stat_D15_id_36_std,cate_stat_D15_M3_sum,cate_stat_TransactionAmt_id_23_std,cate_stat_cross_M4_kernel_median_C14,cate_stat_cross_id_12_kernel_median_TransactionAmt,cate_stat_D15_M9_std,cate_stat_C14_M3_std,cate_stat_TransactionAmt_M9_std,cate_stat_cross_M8_kernel_median_V13,cate_stat_cross_id_33_kernel_median_V13,cate_stat_V13_R_emaildomain_sum,cate_stat_V13_M4_std,cate_stat_C14_id_28_std,cate_stat_cross_id_12_kernel_median_V13,cate_stat_cross_id_38_kernel_median_D15,cate_stat_D15_M7_std,cate_stat_cross_id_16_kernel_median_C14,cate_stat_C14_id_12_std,cate_stat_TransactionAmt_M7_sum,cate_stat_V13_M2_std,cate_stat_TransactionAmt_id_38_sum,cate_stat_C14_id_23_std,cate_stat_cross_ProductCD_kernel_median_V13,cate_stat_cross_id_23_kernel_median_TransactionAmt,cate_stat_cross_M7_kernel_median_TransactionAmt,cate_stat_D15_id_29_sum,cate_stat_cross_M7_kernel_median_C14,cate_stat_D15_M9_sum,cate_stat_D15_id_23_sum,cate_stat_cross_M8_kernel_median_C14,cate_stat_cross_M3_kernel_median_TransactionAmt,cate_stat_cross_M2_kernel_median_D15,cate_stat_TransactionAmt_DeviceType_std,cate_stat_V13_M3_std,cate_stat_cross_id_27_kernel_median_C14,cate_stat_cross_card6_kernel_median_C14,cate_stat_C14_M7_std,cate_stat_C14_M5_sum,cate_stat_C14_DeviceType_sum,cate_stat_cross_id_27_kernel_median_D15,cate_stat_D15_M2_sum,cate_stat_C14_id_37_sum,cate_stat_cross_M2_kernel_median_V13,cate_stat_TransactionAmt_M5_std,cate_stat_cross_M1_kernel_median_C14,cate_stat_C14_id_29_std,cate_stat_TransactionAmt_M8_sum,cate_stat_C14_id_27_std,cate_stat_cross_id_12_kernel_median_C14,cate_stat_TransactionAmt_id_35_sum,cate_stat_D15_M6_std,cate_stat_D15_M4_sum,cate_stat_cross_M8_kernel_median_TransactionAmt,cate_stat_TransactionAmt_id_36_std,cate_stat_cross_id_36_kernel_median_D15,cate_stat_TransactionAmt_id_16_std,cate_stat_cross_id_36_kernel_median_C14,cate_stat_C14_id_36_sum,cate_stat_cross_id_28_kernel_median_C14,cate_stat_cross_id_28_kernel_median_TransactionAmt,cate_stat_C14_M3_sum,cate_stat_D15_card4_sum,cate_stat_D15_M2_std,cate_stat_D15_id_38_sum,cate_stat_V13_M1_sum,cate_stat_D15_id_23_std,cate_stat_V13_R_emaildomain_std,cate_stat_TransactionAmt_id_38_std,cate_stat_C14_M2_std,cate_stat_C14_card6_sum,cate_stat_cross_id_12_kernel_median_D15,cate_stat_cross_id_37_kernel_median_D15,cate_stat_D15_id_35_sum,cate_stat_cross_card6_kernel_median_V13,cate_stat_C14_M9_std,cate_stat_C14_M2_sum,cate_stat_cross_DeviceInfo_kernel_median_V13,cate_stat_TransactionAmt_id_29_sum,cate_stat_C14_id_38_sum,cate_stat_C14_id_35_sum,cate_stat_TransactionAmt_DeviceType_sum,cate_stat_C14_id_36_std,cate_stat_cross_card4_kernel_median_V13,cate_stat_D15_M5_std,cate_stat_cross_M6_kernel_median_D15,cate_stat_cross_id_23_kernel_median_D15,cate_stat_cross_id_29_kernel_median_D15,cate_stat_D15_card6_std,cate_stat_cross_id_35_kernel_median_C14,cate_stat_TransactionAmt_M1_std,cate_stat_D15_id_29_std,cate_stat_cross_R_emaildomain_kernel_median_V13,cate_stat_cross_id_35_kernel_median_D15,cate_stat_V13_id_23_sum,cate_stat_V13_DeviceInfo_sum,cate_stat_V13_id_37_std,cate_stat_TransactionAmt_id_35_std,cate_stat_cross_id_29_kernel_median_TransactionAmt,cate_stat_V13_DeviceType_std,cate_stat_D15_card6_sum,cate_stat_V13_M1_std,cate_stat_cross_id_23_kernel_median_V13,cate_stat_cross_M1_kernel_median_V13,cate_stat_cross_id_35_kernel_median_TransactionAmt,cate_stat_V13_id_16_std,cate_stat_V13_id_36_sum,cate_stat_TransactionAmt_id_27_sum,cate_stat_D15_DeviceType_std,cate_stat_cross_id_36_kernel_median_V13,cate_stat_TransactionAmt_id_28_sum,cate_stat_cross_id_27_kernel_median_TransactionAmt,cate_stat_TransactionAmt_card6_sum,cate_stat_V13_id_16_sum,cate_stat_V13_id_27_std,cate_stat_V13_id_12_std,cate_stat_cross_id_28_kernel_median_V13,cate_stat_cross_id_38_kernel_median_V13,cate_stat_TransactionAmt_id_27_std,cate_stat_cross_DeviceType_kernel_median_V13,cate_stat_C14_card4_sum,cate_stat_D15_M1_std,cate_stat_V13_id_27_sum,cate_stat_V13_id_23_std,cate_stat_D15_id_28_sum,cate_stat_V13_id_38_sum,cate_stat_V13_M9_std,cate_stat_D15_id_16_std,cate_stat_cross_id_29_kernel_median_V13,cate_stat_TransactionAmt_id_37_std,cate_stat_D15_id_27_sum,cate_stat_cross_DeviceType_kernel_median_C14,cate_stat_C14_M1_sum,cate_stat_D15_id_27_std,cate_stat_V13_id_30_std,cate_stat_V13_id_36_std,cate_stat_V13_id_29_sum,cate_stat_D15_id_37_std,cate_stat_V13_id_33_std,cate_stat_cross_M6_kernel_median_C14,cate_stat_C14_id_27_sum,cate_stat_V13_DeviceType_sum,cate_stat_V13_id_12_sum,cate_stat_D15_DeviceType_sum,cate_stat_cross_id_28_kernel_median_D15,cate_stat_TransactionAmt_id_12_sum,cate_stat_TransactionAmt_M1_sum,cate_stat_V13_id_33_sum,cate_stat_V13_id_29_std,cate_stat_V13_id_31_std,cate_stat_cross_id_37_kernel_median_V13,cate_stat_C14_M1_std,cate_stat_D15_id_16_sum,cate_stat_cross_id_30_kernel_median_V13,cate_stat_cross_M3_kernel_median_D15,cate_stat_V13_ProductCD_sum,cate_stat_cross_id_29_kernel_median_C14,cate_stat_cross_id_31_kernel_median_V13,cate_stat_cross_id_16_kernel_median_V13,cate_stat_V13_id_30_sum,cate_stat_V13_id_35_std,cate_stat_TransactionAmt_id_28_std,cate_stat_TransactionAmt_id_29_std,cate_stat_cross_M1_kernel_median_D15,cate_stat_cross_id_35_kernel_median_V13,cate_stat_V13_id_28_sum,cate_stat_V13_id_28_std,cate_stat_V13_ProductCD_std,cate_stat_C14_id_16_sum,cate_stat_D15_id_36_sum,cate_stat_V13_id_37_sum,cate_stat_cross_M7_kernel_median_V13,cate_stat_D15_M1_sum,cate_stat_V13_id_31_sum"
    topn = args.topn
    sub_key = args.fkey

    print sub_key,"subkey"

    allfea = [x for x in allfea.split(",") if x.startswith(sub_key)]
    # if len(allfea) == 0:
    #     allfea = [x for x in args.all_fea.split(",")]
    print len(allfea),"target fea number"

    topfea = allfea[:topn]
    # use_cols = ["card_id"]
    out = out[topfea]
    print out.head()

    # with ut.tick_tock("cal fea"):
    out_cols = sorted(out.columns.tolist())
    # out_cols = ['hist_first_buy']

with ut.tick_tock("write data"):
    feat_key = "_".join([args.key, str(topn)])
    out[:train_index].to_csv(cst.train_prefix + feat_key + '.csv', index=False)
    out[train_index:].to_csv(cst.test_prefix + feat_key + '.csv', index=False)
